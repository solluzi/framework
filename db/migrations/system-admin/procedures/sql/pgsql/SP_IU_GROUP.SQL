CREATE OR REPLACE PROCEDURE "SP_IU_GROUP"("p_data" JSON, "p_user" UUID)
LANGUAGE plpgsql
AS $$
DECLARE
    VU_GROUP_ID     UUID;
    VU_CREATED_BY   UUID;
    VU_UPDATED_BY   UUID;
    VS_NAME         VARCHAR(100);
    VJ_PROGRAMS     JSON;
    VJ_I            JSON;
    VJ_USERS        JSON;
    VJ_J            JSON;
BEGIN
    -- SETS ALL DATAS TO PROPER VARIABLES
    VU_GROUP_ID     = p_user;
    VS_NAME         = p_data->>'name';
    VU_CREATED_BY   = p_user;
    VU_UPDATED_BY   = p_user;
    VJ_PROGRAMS     = p_data->>'programs';
    VJ_USERS        = p_data->>'users';

    -- INSERT OR UPDATE PROGRAM
    INSERT INTO "SYSTEM_GROUP" ("ID", "NAME", "CREATED_BY")
    VALUES(VU_GROUP_ID, VS_NAME, VU_CREATED_BY)
    ON CONFLICT("ID")
    DO
        UPDATE SET "NAME"       = VS_NAME,
                   "NAME"       = VS_NAME,
                   "UPDATED_BY" = VU_UPDATED_BY;

    -- DELETE ALL GROUPS ATTACHED TO GIVEN PROGRAM
    DELETE FROM "SYSTEM_GROUP_PROGRAM" WHERE "GROUP_ID" = VU_GROUP_ID;
    
    -- LOOP THROUGH JSON GROUPS
    FOR VJ_I IN SELECT * FROM JSON_ARRAY_ELEMENTS(VJ_PROGRAMS)
    LOOP
        -- INSERT NEW GROUPS TO GIVEN PROGRAM
        INSERT INTO "SYSTEM_GROUP_PROGRAM" ("GROUP_ID", "PROGRAM_ID") VALUES (VU_GROUP_ID, VJ_I->>'program');
    END LOOP;

    -- DELETE FROM SYSTEM_USER_GROUP OF GIVEN GROUP
    DELETE FROM "SYSTEM_USER_GROUP" WHERE "GROUP_ID" = VU_GROUP_ID;

    -- LOOP THROUGH JSON USERS
    FOR VJ_J IN SELECT * FROM JSON_ARRAY_ELEMENTS(VJ_USERS)
    LOOP
        -- INSERT NEW USER TO GIVEN GROUP
        INSERT INTO "SYSTEM_USER_GROUP" ("USER_ID", "GROUP_ID") VALUES (VJ_I->>'user', VU_GROUP_ID);
    END LOOP;

    COMMIT;
END;$$